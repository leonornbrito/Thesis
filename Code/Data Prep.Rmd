---
title: "Data Prep"
author: "Leonor Brito"
date: "2024-02-20"
output: pdf_document
---

```{r setup}

knitr::opts_knit$set(root.dir = "/Users/leonorbrito/Documents/Master/Thesis/Datasets/OLD")

```

```{r}

library(dplyr)
library(tidyr)
library(purrr)
library(ggplot2)

```

# Import dataframes
```{r}

crop_nutrient_balance <- read.csv('Environment_Cropland_nutrient_budget_E_All_Data.csv')
land_use <- read.csv('Inputs_LandUse_E_All_Data.csv')
land_cover <- read.csv('Environment_LandCover_E_All_Data.csv')
fertilizer_use <- read.csv('Inputs_FertilizersNutrient_E_All_Data.csv')
pesticide_use <- read.csv('Inputs_Pesticides_Use_E_All_Data.csv')
temp_change <- read.csv('Environment_Temperature_change_E_All_Data.csv', fileEncoding = "ISO-8859-1")
employment <- read.csv('Employment_Indicators_Agriculture_E_All_Data.csv')
fertilizer_product <- read.csv('Inputs_FertilizersProduct_E_All_Data.csv')
manure <- read.csv('Environment_LivestockManure_E_All_Data.csv')
yield <- read.csv('Production_Crops_Livestock_E_All_Data.csv')
emissions <- read.csv('Emissions_Totals_E_All_Data_(Normalized).csv')

```

# Data Clean and Prep

## Remove unwanted year columns from all datasets
```{r}

remove_year_FN_columns <- function(df) {
  # Identify columns that end with 'F' or 'N' following a year (assumes year is four digits)
  pattern <- "Y[0-9]{4}[FN]$"
  columns_to_remove <- grep(pattern, names(df), value = TRUE)
  
  # Remove the identified columns from the dataframe
  df <- df[, !names(df) %in% columns_to_remove]
}

```

```{r}

land_cover <- remove_year_FN_columns(land_cover)
land_use <- remove_year_FN_columns(land_use)
employment <- remove_year_FN_columns(employment)
pesticide_use <- remove_year_FN_columns(pesticide_use)
temp_change <- remove_year_FN_columns(temp_change)
crop_nutrient_balance <- remove_year_FN_columns(crop_nutrient_balance)
manure <- remove_year_FN_columns(manure)
fertilizer_product <- remove_year_FN_columns(fertilizer_product)
fertilizer_use <- remove_year_FN_columns(fertilizer_use)
yield <- remove_year_FN_columns(yield)

```

## Remove group rows (regions, continents, etc)

```{r}

# List of areas to remove
areas_to_remove <- c(
    "World", "Africa", "Eastern Africa", "Middle Africa", "Northern Africa", "Southern Africa", "Western Africa",
    "Americas", "Northern America", "Central America", "Caribbean", "South America",
    "Asia", "Central Asia", "Eastern Asia", "Southern Asia", "South-eastern Asia", "Western Asia",
    "Europe", "Eastern Europe", "Northern Europe", "Southern Europe", "Western Europe",
    "Oceania", "Australia and New Zealand", "Melanesia", "Micronesia", "Polynesia",
    "European Union (27)", "Least Developed Countries", "Land Locked Developing Countries",
    "Small Island Developing States", "Low Income Food Deficit Countries", "Net Food Importing Developing Countries"
)

```


## Function to check for NAs
```{r}

calculate_na_sums <- function(dataframe, variable_column) {
  # Identify year columns based on a naming convention (e.g., starting with 'Y_')
  year_columns <- grep("^Y", names(dataframe), value = TRUE)
  
  # Function to calculate sum of NAs for a given variable value within the specified year columns
  sum_nas_by_variable <- function(variable_value) {
    subset_df <- subset(dataframe, dataframe[[variable_column]] == variable_value)
    # Use lapply to handle NA counting, then unlist to ensure the result is a numeric vector
    na_counts <- unlist(lapply(subset_df[year_columns], function(x) sum(is.na(x))))
    sum_na <- sum(na_counts)
    return(sum_na)
  }
  
  # Get unique variable values from the specified variable column
  variables <- unique(dataframe[[variable_column]])
  
  # Calculate the sum of NAs for each variable value
  na_sums <- sapply(variables, sum_nas_by_variable)
  
  # Name the result vector for clarity
  names(na_sums) <- variables
  
  return(na_sums)
}

```


## Independent Vars

### Land Cover

```{r}

calculate_na_sums(land_cover, "Element")

```

```{r}

# Identify rows for "Area from CCI_LC" with NAs in any of the year columns
cci_lc_rows <- land_cover$Element == "Area from CCI_LC"
year_columns <- grep("^Y", names(land_cover), value = TRUE)
na_indices_cci_lc <- which(cci_lc_rows & rowSums(is.na(land_cover[year_columns])) > 0)

# Initialize a list to store results
data_points_in_others <- list()

# Loop through each element value excluding "Area from CCI_LC"
unique_elements <- unique(land_cover$Element[land_cover$Element != "Area from CCI_LC"])
for(elem in unique_elements) {
  # For each element, check corresponding rows in year columns for non-NA where CCI_LC has NA
  elem_rows <- land_cover$Element == elem
  # Subset land_cover for this element and year columns, then check for NAs
  elem_data <- land_cover[elem_rows, year_columns]
  
  # Count how many of the NA indices for CCI_LC have non-NA values for this element
  non_na_counts <- sapply(na_indices_cci_lc, function(index) {
    sum(!is.na(elem_data[index, ]))
  })
  
  # Sum to get total non-NA counts for this element where CCI_LC has NA
  total_non_na_for_elem <- sum(non_na_counts)
  
  # Store in the list with the element name as the key
  data_points_in_others[[elem]] <- total_non_na_for_elem
}

# Print the list to see the counts
print(data_points_in_others)


```

```{r}

# Step 1: Convert the dataset to long format including the Year columns
land_cover_long <- land_cover %>%
  pivot_longer(cols = starts_with("Y"), 
               names_to = "Year", 
               values_to = "Value",
               names_prefix = "Y") %>%
  mutate(Year = as.numeric(Year)) # Ensure Year is numeric

# Step 2: Group by Area, Item, and Year to calculate the average across Elements
# Note that we assume 'Element' is also a column in your dataset
land_cover_avg <- land_cover_long %>%
  group_by(Area.Code, Area, Item, Year) %>%
  summarise(Average_Value = mean(Value, na.rm = TRUE), .groups = 'drop')

# Step 3: Spread the Item column to wide format
land_cover_final <- land_cover_avg %>%
  pivot_wider(names_from = Item, 
              values_from = Average_Value)

```

### Land Use

```{r}

# Define the combinations of interest
combinations_of_interest <- data.frame(
  Item = c("Agricultural land", "Cropland", "Arable land", "Permanent crops", 
           "Land area equipped for irrigation", "Land area actually irrigated", 
           "Agriculture area under organic agric.", "Forest land"),
  Element = c("Share in Land area", "Share in Agricultural land", "Share in Agricultural land", 
              "Share in Agricultural land", "Share in Cropland", 
              "Area", 
              "Share in Agricultural land", "Share in Land area")
)

# Filter the land_use dataframe to keep only the rows that match the combinations of interest
filtered_land_use <- land_use %>%
  semi_join(combinations_of_interest, by = c("Item", "Element"))

# Get unique countries from the land_use data
unique_countries <- unique(land_use$Area)

# For each item-element combination, calculate how many countries it's missing from
missing_combinations_count <- combinations_of_interest %>%
  rowwise() %>%
  mutate(MissingInCountriesCount = length(unique_countries) - 
         sum(land_use$Item == Item & land_use$Element == Element)) %>%
  ungroup()

# View the result
print(missing_combinations_count)

```
Remove "Land area actually irrigated"
```{r}

filtered_land_use <- filtered_land_use %>%
  filter(Item != "Land area actually irrigated")

```
Concatenate Element and Item to make one variable column
```{r}

filtered_land_use <- filtered_land_use %>%
  mutate(combined = paste(Item, Element, sep = ", "))

# Remove unwanted columns
filtered_land_use <- filtered_land_use %>%
  select(-c(Item.Code, Item, Element.Code, Element, Area.Code..M49., Unit))

```
Convert variable to wide format, years to long format
```{r}

# Pivot years columns to long format
land_use_long <- filtered_land_use %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
land_use_final <- land_use_long %>%
  pivot_wider(
    names_from = combined,
    values_from = Value
  )

```

### Pesticide Use

```{r}

pesticide_use_filtered <- pesticide_use %>%
  filter(Item == "Pesticides (total)" & Element == "Use per area of cropland")

# concatenate Item and Element to create a new variable
pesticide_use_filtered <- pesticide_use_filtered %>%
  mutate(combined = paste(Item, Element, sep = ", "))

# remove unwanted columns
pesticide_use_filtered <- pesticide_use_filtered %>%
  select(-c(Item.Code, Item, Element.Code, Element, Area.Code..M49., Unit))

```

Convert variable to wide format, years to long format
```{r}

# Pivot years columns to long format
pesticide_use_long <- pesticide_use_filtered %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
pesticide_use_final <- pesticide_use_long %>%
  pivot_wider(
    names_from = combined,
    values_from = Value
  )

```

### Temp Change

```{r}

temp_change_filtered <- temp_change %>%
  filter(Months == "Meteorological year", Element == "Temperature change")

```

Convert variable to wide format, years to long format
```{r}

# Pivot years columns to long format
temp_change_long <- temp_change_filtered %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
temp_change_final <- temp_change_long %>%
  pivot_wider(
    names_from = Element,
    values_from = Value
  )


names(temp_change_final)[names(temp_change_final) == "Temperature change"] <- "Temperature change (C)"

# remove unwanted columns
temp_change_final <- temp_change_final %>%
  select(-c(Area.Code..M49., Months.Code, Months, Element.Code, Unit))

```


### Crop Nutrient Balance

```{r}

# Filter the crop_nutrient_balance dataset for nue Element values
filtered_nue <- subset(crop_nutrient_balance, Element %in% c("Cropland nitrogen use efficiency", 
                                                            "Cropland phosphorus use efficiency", 
                                                            "Cropland potassium use efficiency"))

# Pivot years columns to long format
nue_long <- filtered_nue %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
nue_final <- nue_long %>%
  pivot_wider(
    id_cols = c(Area.Code, Area, Year),
    names_from = Element,
    values_from = Value
  )


```

### Manure Management

```{r}

# Filter the crop_nutrient_balance dataset for nue Element values
filtered_manure <- subset(manure, Element %in% c("Stocks", "Amount excreted in manure (N content)", "Manure left on pasture (N content)"))

# Pivot years columns to long format
manure_long <- filtered_manure %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
manure_wide <- manure_long %>%
  pivot_wider(
    id_cols = c(Area.Code, Area, Item, Year),
    names_from = Element,
    values_from = Value
  )


# Calculate averages and remove the "Item" column
manure_final <- manure_wide %>%
  group_by(Area.Code, Area, Year) %>%
  summarise(
    Avg_Stocks = mean(`Stocks`, na.rm = TRUE),
    Avg_Amount_Excreted = sum(`Amount excreted in manure (N content)`, na.rm = TRUE),
    Avg_Manure_Left_On_Pasture = sum(`Manure left on pasture (N content)`, na.rm = TRUE)
  ) %>%
  ungroup()  # Optional, to remove the grouping structure


```

### Fertilizer Management

```{r}

# Filter the crop_nutrient_balance dataset for nue Element values
filtered_fertilizer <- subset(fertilizer_use, Element %in% c("Production", "Import Quantity", "Export Quantity"))

filtered_fertilizer$combined <- paste(filtered_fertilizer$Item, filtered_fertilizer$Element, sep = ", ")


# Pivot years columns to long format
fertilizer_long <- filtered_fertilizer %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Value"
  )

# Pivot the 'combined' column to wide format
fertilizer_final <- fertilizer_long %>%
  pivot_wider(
    id_cols = c(Area.Code, Area, Year),
    names_from = combined,
    values_from = Value
  )

# Create import/export ratio variable
fertilizer_final$N.ImportExport.Ratio <- fertilizer_final[["Nutrient nitrogen N (total), Import Quantity"]] / fertilizer_final[["Nutrient nitrogen N (total), Export Quantity" ]]
fertilizer_final$P.ImportExport.Ratio <- fertilizer_final[["Nutrient phosphate P2O5 (total), Import Quantity"]] / fertilizer_final[["Nutrient phosphate P2O5 (total), Export Quantity"]]
fertilizer_final$K.ImportExport.Ratio <- fertilizer_final[["Nutrient potash K2O (total), Import Quantity"]] / fertilizer_final[["Nutrient potash K2O (total), Export Quantity"]]

fertilizer_final <- fertilizer_final %>%
  select(-c(5, 6, 8, 9, 11, 12))

```


## Depdendent Var

### Crop Yield

```{r}

filtered_yield <- subset(yield, Element %in% c("Yield"))

# Pivot years columns to long format
yield_long <- filtered_yield %>%
  pivot_longer(
    cols = starts_with("Y"),
    names_to = "Year",
    values_to = "Yield"
  )

yield_final <- yield_long[c("Area.Code", "Area", "Item", "Year", "Yield")]

yield_by_region <- yield_final[yield_final$Area %in% areas_to_remove, ]
yield_by_country <- yield_final[!yield_final$Area %in% areas_to_remove, ]

```

```{r}

calculate_average_yield <- function(data) {
  # Ensure the Year column is numeric, removing any "Y" prefix
  data$Year <- as.numeric(sub("Y", "", data$Year))
  
  # Convert the Yield column to numeric, setting any NaN values to NA
  data$Yield <- as.numeric(replace(data$Yield, is.nan(data$Yield), NA))
  
  # Calculate the average yield for each Area and Item, filtering for years 2003 to 2021
  average_yields <- data %>%
    filter(Year >= 2003 & Year <= 2021) %>%
    group_by(Area, Item) %>%
    summarize(AverageYield = mean(Yield, na.rm = TRUE), .groups = 'drop')
  
  # Return the average yields dataframe
  return(average_yields)
}

avg_yield_country <- calculate_average_yield(yield_by_country)
avg_yield_region <- calculate_average_yield(yield_by_region)

```

### Food groups

```{r}

# Define vectors for each food group
fruits_and_berries <- c(
  "Apples", "Apricots", "Figs", "Grapes", "Oranges",
  "Peaches and nectarines", "Pears", "Plums and sloes", "Watermelons",
  "Other citrus fruit, n.e.c.", "Other berries and fruits of the genus vaccinium n.e.c.",
  "Other fruits, n.e.c.", "Cantaloupes and other melons", "Cherries",
  "Lemons and limes", "Tangerines, mandarins, clementines", "Strawberries",
  "Quinces", "Bananas", "Pineapples", "Avocados", "Papayas", "Kiwi fruit",
  "Blueberries", "Raspberries", "Other tropical fruits, n.e.c.", "Other pome fruits", 
  "Citrus Fruit, Total", "Fruit Primary", "Dates", "Pomelos and grapefruits", "Currants",
  "Cranberries", "Sour cherries", "Cocoa beans", "Coffee, green", "Areca nuts")

vegetables <- c(
  "Potatoes", "Tomatoes", "Cucumbers and gherkins", 
  "Chillies and peppers, green (Capsicum spp. and Pimenta spp.)",
  "Green garlic", "Leeks and other alliaceous vegetables", "Lettuce and chicory",
  "Carrots and turnips", "Cauliflowers and broccoli", "Cabbages", "Artichokes",
  "Asparagus", "Eggplants (aubergines)", "Okra", "String beans", "Peas, green",
  "Other beans, green", "Onions and shallots, green", "Other vegetables, fresh n.e.c.", 
  "Pumpkins, squash and gourds", "Potatoes", "Onions and shallots, dry (excluding dehydrated)",
  "Other vegetables, fresh n.e.c.", "Cabbages", "Carrots and turnips",
  "Cauliflowers and broccoli", "Chillies and peppers, green (Capsicum spp. and Pimenta spp.)",
  "Cucumbers and gherkins", "Eggplants (aubergines)", "Green garlic",
  "Leeks and other alliaceous vegetables", "Lettuce and chicory", "Okra",
  "Onions and shallots, green", "Other beans, green", "Peas, green", 
  "Pumpkins, squash and gourds", "Tomatoes", "Artichokes", 
  "Chillies and peppers, dry (Capsicum spp., Pimenta spp.), raw", "Spinach","Vetches",
  "Asparagus", "String beans", "Vegetables Primary")

dairy_and_eggs <- c("Eggs Primary", "Hen eggs in shell, fresh", "Milk, Total", 
                    "Raw milk of camel", "Raw milk of cattle", "Raw milk of goats", 
                    "Raw milk of sheep", "Raw milk of buffalo", 
                    "Eggs from other birds in shell, fresh, n.e.c.")

cereals <- c("Cereals n.e.c.", "Green corn (maize)","Barley", "Maize (corn)", "Millet", "Oats",
             "Rice", "Rye", "Sorghum", "Wheat", "Cereals, primary", "Triticale", "Buckwheat",
             "Mixed grain")

pulses_nuts_legumes <- c(
  "Beans, dry", "Broad beans and horse beans, dry", "Chick peas, dry", "Cow peas, dry",
  "Lentils, dry", "Peas, dry", "Pigeon peas, dry", "Broad beans and horse beans, green",
  "Pulses, Total", "Other pulses n.e.c.", "Almonds, in shell", 
  "Other nuts (excluding wild edible nuts and groundnuts), in shell, n.e.c.",
  "Walnuts, in shell", "Pistachios, in shell", "Hazelnuts, in shell", "Mustard seed",
  "Sesame seed", "Sunflower seed", "Linseed", "Treenuts, Total","Other pulses n.e.c.", 
  "Cashew nuts, in shell", "Chestnuts, in shell", "Other stone fruits","Soya beans", "Lupins",
  "Safflower seed", "Tung nuts","Bambara beans, dry", "Melonseed", "Poppy seed", "Groundnuts, excluding shelled", "Locust beans (carobs)")

oil_crops <- c(
  "Olives", "Oilcrops, Cake Equivalent", "Oilcrops, Oil Equivalent", "Rape or colza seed",
  "Safflower seed", "Castor oil seeds", "Oil palm fruit", "Tung nuts", 
  "Other oil seeds, n.e.c.",
  "Oilcrops, Cake Equivalent", "Oilcrops, Oil Equivalent", "Rape or colza seed", 
  "Castor oil seeds", "Oil palm fruit", "Other oil seeds, n.e.c.")

sugar_crops <- c(
  "Sugar beet", "Sugar cane", "Sugar Crops Primary","Other sugar crops n.e.c.")

fiber_crops <- c(
  "Seed cotton, unginned", "Fibre Crops, Fibre Equivalent","Fibre Crops, Fibre Equivalent", "Flax, raw or retted","Other fibre crops, raw, n.e.c.", "Ramie, raw or retted")

roots_tubers <- c("Roots and Tubers, Total", "Sweet potatoes", "Taro", "Yams", 
                  "Cassava, fresh", 
                  "Edible roots and tubers with high starch or inulin content, n.e.c., fresh",
                  "Yautia", "Chicory roots")

spices_aromatics <- c(
  "Anise, badian, coriander, cumin, caraway, fennel and juniper berries, raw",
  "Other stimulant, spice and aromatic crops, n.e.c.", "Pepper (Piper spp.), raw",
  "Nutmeg, mace, cardamoms, raw", "Vanilla, raw", "Cinnamon and cinnamon-tree flowers, raw",
  "Cloves (whole stems), raw","Ginger, raw", "Peppermint, spearmint")

tropical_other_fruits <- c("Mangoes, guavas and mangosteens", "Other tropical fruits, n.e.c.", 
                           "Cashewapple", "Coconuts, in shell", "Plantains and cooking bananas")

industrial_crops <- c(
  "Unmanufactured tobacco", "Hop cones", "Natural rubber in primary forms", "Jute, raw or retted",
  "Sisal, raw", "Abaca, manila hemp, raw", "Kenaf, and other textile bast fibres, raw or retted",
  "Ramie, raw or retted", "True hemp, raw or retted", "Mat\xe9 leaves")

miscellaneous <- c("Hempseed", "Persimmons", 
                   "Gooseberries", "Karite nuts (sheanuts)", "Kola nuts", "Quinoa", 
                   "Tallowtree seeds", "Agave fibres, raw, n.e.c.", "Cassava leaves",
                   "Pyrethrum, dried flowers", "Kapok fruit", "Jojoba seeds", "Canary seed", 
                   "Tea leaves", "Fonio", "Beeswax")

animal_products <- c("Raw hides and skins of cattle", "Raw hides and skins of goats or kids", 
                     "Raw hides and skins of sheep or lambs", 
                     "Raw hides and skins of buffaloes")

# Combine vectors into a data frame for mapping
food_group_mapping <- data.frame(
  Item = c(fruits_and_berries, vegetables, dairy_and_eggs, cereals, pulses_nuts_legumes,
           oil_crops, sugar_crops, fiber_crops, roots_tubers, spices_aromatics, 
           tropical_other_fruits, industrial_crops, miscellaneous, animal_products),
  FoodGroup = c(rep("Fruits and Berries", length(fruits_and_berries)),
                rep("Vegetables", length(vegetables)),
                rep("Dairy and Eggs", length(dairy_and_eggs)),
                rep("Cereals", length(cereals)),
                rep("Pulses, Nuts, and Legumes", length(pulses_nuts_legumes)),
                rep("Oil Crops", length(oil_crops)),
                rep("Sugar Crops", length(sugar_crops)),
                rep("Fiber Crops", length(fiber_crops)),
                rep("Roots and Tubers", length(roots_tubers)),
                rep("Spices and Aromatics", length(spices_aromatics)),
                rep("Tropical and Other Fruits", length(tropical_other_fruits)),
                rep("Industrial Crops", length(industrial_crops)),
                rep("Miscellaneous", length(miscellaneous)),
                rep("Animal Products", length(animal_products)))
)


```

```{r}

# Join the mapping with the average_yields to map each item to its food group
avg_yield_region_foodgroups <- avg_yield_region %>%
  left_join(food_group_mapping, by = "Item")

```

```{r}

# Define the function
calculate_yield_stats <- function(data, stat = c("sum", "mean")) {
  # Ensure that stat is a single character string matching either "sum" or "mean"
  stat <- match.arg(stat)
  
  # Compute total yield by food group and area
  total_yield_by_foodgroup <- data %>%
    group_by(Area, FoodGroup) %>%
    summarize(Yield = match.fun(stat)(AverageYield, na.rm = TRUE), .groups = 'keep')

  # Compute total yield by area
  total_yield_by_area <- data %>%
    group_by(Area) %>%
    summarize(TotalYield = sum(AverageYield, na.rm = TRUE), .groups = 'keep')

  # Join and calculate the proportion
  result <- total_yield_by_foodgroup %>%
    left_join(total_yield_by_area, by = "Area") %>%
    mutate(Proportion = Yield / TotalYield)

  # Select the relevant columns
  final_result <- result %>%
    select(Area, FoodGroup, Yield, Proportion)

  return(final_result)
}

```


```{r}

mean_yield_by_foodgroup <- calculate_yield_stats(avg_yield_region_foodgroups, stat="mean")
total_yield_by_foodgroup <- calculate_yield_stats(avg_yield_region_foodgroups, stat="sum")

# Now plot total yield by foodgroup and region
ggplot(total_yield_by_foodgroup, aes(x = Area, y = Proportion, fill = FoodGroup)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the coordinates for horizontal bars
  theme_minimal() +
  scale_y_continuous(labels = scales::percent_format()) +  # Convert the y-axis into percentage format
  labs(x = "Area", y = "Proportion", fill = "Food Group",
       title = "Proportion of Food Groups by Area") +
  theme(legend.text = element_text(size = 8))  # Move the legend to the bottom

# Now plot mean yield by foodgroup and region
ggplot(mean_yield_by_foodgroup, aes(x = Area, y = Yield, fill = FoodGroup)) +
  geom_bar(stat = "identity") +
  coord_flip() +  # Flip the coordinates for horizontal bars
  theme_minimal() +
  labs(x = "Area", y = "Mean Yield", fill = "Food Group",
       title = "Mean Yield of Food Groups by Area") +
  theme(legend.text = element_text(size = 8))  # Move the legend to the bottom

```



# Combine all datasets

```{r}

# Function to convert Year column: remove "Y" prefix and convert to numeric
convert_year <- function(df) {
  df %>%
    mutate(Year = as.numeric(sub("Y", "", Year))) %>%
    return()
}

# Apply the function to each dataset
fertilizer_final <- convert_year(fertilizer_final)
land_cover_final <- convert_year(land_cover_final)
land_use_final <- convert_year(land_use_final)
manure_final <- convert_year(manure_final)
nue_final <- convert_year(nue_final)
pesticide_use_final <- convert_year(pesticide_use_final)
temp_change_final <- convert_year(temp_change_final)


# Now, perform the full joins
combined_final <- fertilizer_final %>%
  full_join(land_cover_final, by = c("Area.Code", "Area", "Year")) %>%
  full_join(land_use_final, by = c("Area.Code", "Area", "Year")) %>%
  full_join(manure_final, by = c("Area.Code", "Area", "Year")) %>%
  full_join(nue_final, by = c("Area.Code", "Area", "Year")) %>%
  full_join(pesticide_use_final, by = c("Area.Code", "Area", "Year")) %>%
  full_join(temp_change_final, by = c("Area.Code", "Area", "Year"))


# Standardize variable column names
year_col_pos <- which(names(combined_final) == "Year")
names(combined_final)[(year_col_pos+1):ncol(combined_final)] <- variable_names

```


```{r}

# Define the variable names
variable_names <- c(
  "n.fert.prod", "p.fert.prod", "k.fert.prod", 
  "n.fert.ratio", "p.fert.ratio", "k.fert.ratio",
  "artif.surf", "coast.water", "grassland", 
  "herb.crops", "inl.water", "magroves", 
  "mult.crops", "snow.areas", "shrub.areas", 
  "flood.areas", "veg.areas", "barren.land", 
  "tree.cover", "woordy.crops", "ag.land.la", 
  "cropland.al", "arable.land.al", "perm.crops.al", 
  "forest.land.al", "irrig.land.cl", "org.land.al", 
  "manure.stocks", "manure.exc", "manure.left", 
  "nue", "pue", "kue", "pest.cl", "temp.change"
)

# Define the descriptions
descriptions <- c(
  "Nutrient nitrogen N (total), Production", "Nutrient phosphate P2O5 (total), Production", "Nutrient potash K2O (total), Production",
  "Nutrient nitrogen N, Import/Export Ratio", "Nutrient phosphate P2O5 (total), Import/Export Ratio", "Nutrient potash K2O (total), Import/Export Ratio",
  "Artificial surfaces (including urban and associated areas)", "Coastal water bodies and intertidal areas", "Grassland",
  "Herbaceous crops", "Inland water bodies", "Mangroves",
  "Multiple or layered crops", "Permanent snow and glaciers", "Shrub-covered areas",
  "Shrubs and/or herbaceous vegetation, aquatic or regularly flooded", "Sparsely natural vegetated areas", "Terrestrial barren land",
  "Tree-covered areas", "Woody crops", "Agricultural land, Share in Land area",
  "Cropland, Share in Agricultural land", "Arable land, Share in Agricultural land", "Permanent crops, Share in Agricultural land",
  "Forest land, Share in Land area", "Land area equipped for irrigation, Share in Cropland", "Agriculture area under organic agric., Share in Agricultural land",
  "Total Manure Stocks", "Amount excreeted in manure (N content)", "Manure left on pasture (N content)",
  "Cropland nitrogen use efficiency", "Cropland phosphorus use efficiency", "Cropland potassium use efficiency",
  "Pesticides (total), Use per area of cropland", "Temperature change"
)

# Define the units
units <- c(
  "t", "t", "t", "t/t", "t/t", "t/t", 
  "1000 ha", "1000 ha", "1000 ha", 
  "1000 ha", "1000 ha", "1000 ha", 
  "1000 ha", "1000 ha", "1000 ha", 
  "1000 ha", "1000 ha", "1000 ha", 
  "1000 ha", "1000 ha", "%", 
  "%", "%", "%", 
  "%", "%", "%", 
  "An", "kg", "kg", 
  "%", "%", "%", 
  "kg/ha", "Â°c"
)

# Create the data frame
variables_table <- data.frame(Variable = variable_names, Description = descriptions, Unit = units)

# Print the data frame
print(variables_table)


```

```{r}

# Remove rows where the 'Area' is in the list of areas to remove and Year 2022
combined_final <- combined_final[!combined_final$Area %in% areas_to_remove & combined_final$Year != 2022, ]

```

